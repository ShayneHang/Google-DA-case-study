---
title: "Google Data Analytics Capstone Case Study with R"
author: "KwangHui"
date: '2022-06-21'
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Summary

Bellabeat is a small high-tech manufacturer of health-focused smart products founded in 2013, they collect data on activity, sleep, stress, and reproductive health to empower women with knowledge about their own health and habits.

This report will analyze smart device usage data in order to gain insight into how consumers use non-Bellabeat smart devices to reveal more opporunities for growth.

We will be focusing on Bellabeat's app. Their app provides users with health data related to their activity, sleep, stress, menstrual cycle, and mindfulness habits. This data can help users better understand their current habits and make healthy decisions. The Bellabeat app connects to their line of smart wellness products.


### Prepare Phase

The dataset used for this report is [FitBit Fitness Tracker Data](https://www.kaggle.com/datasets/arashnic/fitbit). The dataset is made available through Mobius in Kaggle. 

These dataset were generated by respondents to a distributed survey via Amazon Mechanical Turk between 03.12.2016 - 05.12.2016. Thirty eligible Fitbit users consented to the submission of personal tracker data, including minute-level output for physical activity, heart rate, and sleep monitoring.   

The dataset is licensed: CC0: Public Domain - *The person who associated a work with this deed has dedicated the work to the public domain by waiving all of his or her rights to the work worldwide under copyright law, including all related and neighboring rights, to the extent allowed by law. You can copy, modify, distribute and perform the work, even for commercial purposes, all without asking permission.*  

**Understanding the Dataset**

```{r echo=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl)
library(readr)
library(dplyr)
library(skimr)
library(janitor)
library(magrittr)
library(ggplot2)
library(lubridate)
library(ggpubr)
library(gapminder)
library(gganimate)
library(ggthemes) 
library(transformr) 
library(gifski) 
```

We will first take a quick look at the number of rows, columns and number of unique participants.

```{r}

#capturing all the dataset
files <- list.files(
  path = "D:\\User\\Courses\\Google Data Analytics coursera\\case study dataset",
  pattern  = ".csv",
  full.names = TRUE
)

#loop to store num of rows & cols & unique IDs
numrows <- c()
numcols <- c()
numunique <- c()

for (i in 1:18) {
  xzy <- read.csv(files[i])
  numrows <- append(numrows, nrow(xzy))
  numcols <- append(numcols, ncol(xzy))
  numunique <- append(numunique, n_unique(xzy$Id))
}

#remove path name from files
files <- list.files(
  path = "D:\\User\\Courses\\Google Data Analytics coursera\\case study dataset",
  pattern  = ".csv",
  full.names = FALSE
)

#loop to store dataset name
datasetlist <- c()

for (i in 1:18) {
  datasetlist <- append(datasetlist, files[i])
}

#dataset details
excelrowscols <- data.frame(dataset = datasetlist, rows = numrows, 
                            cols = numcols, numofparticipants = numunique)

excelrowscols[order(excelrowscols$rows),]
```
  
  
**Highlights about the dataset:**

Datasets are mainly broken down into:
    
1. dailyActivity_merged.csv - data on the daily activities of 33 user. The data tracked included Steps, Distance, Intensities, Calorie traced daily.
    + dailyCalories_merged.csv, dailyIntensities_merged.csv, dailySteps_merged.csv are all subsets of dailyActivity_merged.csv.
    + hourlyCalories_merged.csv, hourlyIntensities_merged.csv, hourlySteps_merged.csv are also subsets of dailyActivity_merged.csv but data are tracked every hour of everyday.
    + minuteCaloriesWide_merged.csv, minuteIntensitiesWide_merged.csv & minuteStepsWide_merged.csv are also subset of dailyActivity_merged.csv., but data are tracked every minute and presented in wide format.
    + minuteCaloriesNarrow_merged.csv, minuteIntensitiesNarrow_merged.csv, minuteStepsNarrow_merged.csv are also subset of dailyActivity_merged.csv., but data are tracked every minute and presented in long format. 

2. minuteMETsNarrow_merged.csv is data of how how much energy a person expends based on the amount of oxygen consumed by the body with 33 unique users identified.
3. sleepDay_merged.csv is data on user's daily sleep logs. The logs included total count of sleeps a day, total minutes asleep & total time in bed. Only 24 unique users identified.
4. heartrate_seconds_merged.csv is data on user's heartrate recorded in intervals of between 5 - 20 seconds and only 14 users identified. 
5. weightLogInfo_merged.csv is data on user's weight and BMI. Days tracked are inconsistent among users and only 8 unique users identified.
6. minuteSleep_merged.csv has no extra details provided on columns variables. Unable to extract further information about this dataset.  
  
  
**Statistical inference of the dataset**

These datasets are an example of non-probability samples as they were generated by respondents to a distributed survey via Amazon Mechanical Turk, in addition they have small samples size of between 8 to 33 samples varying across each dataset. Hence we like to highlight that there will be risk of sampling bias and that sampled units are not representative of larger target population of interest. 


### Process Phase
From earlier we see that there are some datasets with >1,048,576 rows, which exceed the maximum number of rows excel can load. Hence we will be using RStudio to process, clean and share our data.

We will be using the following dataset for our analysis:

  * dailyActivity_merged.csv
  * sleepDay_merged.csv
  * minuteMETsNarrow_merged.csv
    
We chose to not use the calories/intensity/steps dataset as they are subsets of the dailyActivity_merged.csv. weightLogInfo_merged.csv & minuteSleep_merged.csv are not favourable for analysis due to their small sample size, inconsistent data and incomplete metadata of the dataset.  
  

**Deeper look at our dataset**

Now that we understood more about our data structures, we will process them to look for any errors and inconsistencies.

```{r message=FALSE, warning=FALSE}
#read files
daily_activities <- read_csv('D:\\User\\Courses\\Google Data Analytics coursera\\case study dataset\\dailyActivity_merged.csv')
sleep_log <- read_csv('D:\\User\\Courses\\Google Data Analytics coursera\\case study dataset\\sleepDay_merged.csv')
minmets <- read_csv('D:\\User\\Courses\\Google Data Analytics coursera\\case study dataset\\minuteMETsNarrow_merged.csv')

#check colume types
str(daily_activities)
str(sleep_log)
str(minmets)
```

```{r message=FALSE, warning=FALSE}
#check for duplicates
sum(duplicated(daily_activities))
sum(duplicated(sleep_log))
sum(duplicated(minmets))
```
  
From above, we have noticed that:

  * date columns are of the character type
  * duplicates have been noted in one of the datasets

We will then proceed to correct the date type as well as to remove duplicates

```{r message=FALSE, warning=FALSE}
#remove duplicates and NA rows
daily_activities <- daily_activities %>% distinct() %>% drop_na()
sleep_log <- sleep_log %>% distinct() %>% drop_na()
minmets <- minmets %>% distinct() %>% drop_na()

#check
sum(duplicated(daily_activities))
sum(duplicated(sleep_log))
sum(duplicated(minmets))
```

```{r message=FALSE, warning=FALSE}
#correct the date type and rename column names for merging
daily_activities <- daily_activities %>%
  rename(date = ActivityDate) %>%
  mutate(date = as.Date(date, format = "%m/%d/%Y"))

#format as date without time as all the time in sleep_log is at 12am
sleep_log <- sleep_log %>%
  rename(date = SleepDay) %>%
  mutate(date = as.Date(date, format = "%m/%d/%Y"))

minmets <- minmets %>%
  mutate(ActivityMinute = as.POSIXct(ActivityMinute, format = "%m/%d/%Y %I:%M:%S %p"))

#check
colnames(daily_activities)
class(daily_activities$date)
colnames(sleep_log)
class(sleep_log$date)
colnames(minmets)
class(minmets$ActivityMinute)
```
  
With the dates corrected and duplicates removed, we proceeded to merge daily_activities and sleep_log dataset for analysis.

```{r message=FALSE, warning=FALSE}
#merge
daily_activities_sleep <- merge(daily_activities, sleep_log)

#check
str(daily_activities_sleep)
```
As sleep_log dataset only have 24 samples, the combined dataset from daily_activities & sleep_log can only have a maximum of 24 samples instead of 33.

These will be the datasets for our analysis:

1. daily_activities_sleep (combination of 'dailyActivity_merged.csv' & 'sleepDay_merged.csv')
2. minmets (from 'minuteMETsNarrow_merged.csv')


### Analyze & Share Phase
We will now begin to analyze the selected dataset to see what we can learn from them.

Based on the data that we have, we will explore these 2 areas:

1. Activity level (using: 'daily_activities_sleep' & 'minmets')
2. Sleep behaviour (using: 'daily_activities_sleep')
  
  
**1. User's activity level**


**Calories**

Based on Fitbit's [FAQ](https://help.fitbit.com/articles/en_US/Help_article/1141.htm), their devices will also record user's basal metabolic rate (BMR) - *the rate at which you burn calories at rest to maintain vital body functions (including breathing, blood circulation, and heartbeat) even when the users are not actively doing anything. User's BMR is based on the physical data they entered in to their Fitbit account (height, weight, sex, and age) and accounts for at least half the calories they burn in a day.*

According to this [article](https://www.goodto.com/wellbeing/diets-exercise/what-is-calorie-how-many-lose-weigt-425557) an average person BMR is approximately 1800 calories per day. Hence we will deduct 1800 calories from the recorded calories burned to find the daily average estimate of calories a user burns on top of their BMR.
  
  
**Steps**

Walking [10,000 steps](https://www.healthhub.sg/live-healthy/1282/the-surprising-health-benefits-of-10000-steps) per day is the recommended guideline to meet for healthy adults to achieve health benefits.
  
  
Next we will now look at user's average steps & calories burned per day.

```{r message=FALSE, warning=FALSE}
daily_activities_sleep %>% 
  group_by(Id) %>% 
  summarise(avgsteps = mean(TotalSteps), avgcal = mean(Calories), addcalburn = avgcal - 1800) %>% 
  select(avgsteps, avgcal, addcalburn) %>% 
  summary(addcalburn)
```
```{r message=FALSE, warning=FALSE}
daily_activities_sleep %>% 
  transform(Id = as.character(Id)) %>% 
  group_by(Id) %>% 
  summarise(avgsteps = mean(TotalSteps), avgcal = mean(Calories)) %>% 
  ggplot() +
  geom_col(aes(Id, avgsteps, fill = 'grey')) +
  geom_col(aes(Id, avgcal, fill = 'blue')) +
  geom_hline(yintercept = 10000, colour = 'black') + #10000 is the steps per day
  geom_hline(yintercept = 1800, colour = 'red', size = 0.8) + #1800 is the BMR calories
  scale_y_continuous(breaks = c(0, 1800, 5000, 10000, 15000, 20000)) +
  theme(axis.text.x = element_text(angle = 90)) +
  xlab('participant ID') +
  ylab('avg steps & calories burn per day') +
  scale_fill_manual(values = c('blue', 'grey'), name = 'Legend', labels = c('Calories', 'Steps'))
```

From above statistical summary, users clocked an average steps of 7880 per day, which is lesser than the recommended guideline of 10000 steps per day. However they are burning an additional 597.3 calories on average per day on top of their BMR. 

Next, the graph above narrows down to individual user's average daily steps and calories. It shows only 5 users have managed to hit the recommended 10000 steps per day and while the rest who did not, some have still managed to burn as much calories as those who did - for example ID 4020332650 vs 4388161847 and 8053475328 vs 8378563200.

This suggests that clocking more steps does not equate to burning more calories. Users may be doing other form of activities that did not involve tracking their steps such as swimming.

  
**Sedentary vs Active behaviour**

A sedentary behaviour involves long periods of sitting and/or lying down, with very little to no exercise. Quoting from World Health Organisation [(WHO)](https://www.who.int/news/item/04-04-2002-physical-inactivity-a-leading-cause-of-disease-and-disability-warns-who#:~:text=Sedentary%20lifestyles%20increase%20all%20causes,lipid%20disorders%2C%20depression%20and%20anxiety.) *'Sedentary lifestyles increase all causes of mortality, double the risk of cardiovascular diseases, diabetes, and obesity, and increase the risks of colon cancer, high blood pressure, osteoporosis, lipid disorders, depression and anxiety...Among the preventive measures recommended by WHO are moderate physical activity for up to 30 minutes every day'*

We will take a look at users' sedentary vs active behaviours

```{r message=FALSE, warning=FALSE}
daily_activities_sleep %>% 
  transform(Id = as.character(Id)) %>% 
  group_by(Id) %>% 
  summarise(avgsed = mean(SedentaryMinutes), avgactive = mean(VeryActiveMinutes+FairlyActiveMinutes)) %>% 
  ggplot() +
  geom_col(aes(Id, avgsed, fill = 'grey')) +
  geom_col(aes(Id, avgactive, fill = 'blue')) +
  theme(axis.text.x = element_text(angle = 90)) +
  xlab('participant ID') +
  ylab('avg Sedentary & Active mins per day') +
  scale_fill_manual(values = c('blue', 'grey'), name = 'Legend', labels = c('Active minutes', 'Sedentary Minutes'))
```

We can see a stark difference between the user's sedentary and active periods. However this may also be heavily influenced by user's occupation. For example if we were to compare a labourer's sedentary and active periods to that of a white collar worker's data, it is reasonable to assume the labourer would yield higher active to sedentary minutes per day. 

Next we will zoom in on users' active period.

```{r message=FALSE, warning=FALSE}
daily_activities_sleep %>% 
  transform(Id = as.character(Id)) %>% 
  group_by(Id) %>% 
  summarise(avgactive = mean(VeryActiveMinutes+FairlyActiveMinutes)) %>% 
  ggplot() +
  geom_col(aes(Id, avgactive)) +
  geom_hline(yintercept = 30, colour = 'red') +
  scale_y_continuous(breaks = c(0, 30, 50, 100)) +
  theme(axis.text.x = element_text(angle = 90)) +
  xlab('participant ID') +
  ylab('avg active min per day')
```

Based on WHO's recommendation of moderate physical activity of up to 30 minutes every day, we can see an even distribution of users that can and cannot meet this guideline. 
  
**Metabolic Equivalent Minutes (MET)**

MET is a measure of how how much energy a person expends based on the amount of oxygen consumed by the body.  [*Energy expenditure may differ from person to person based on several factors, including your age and fitness level. For example, a young athlete who exercises daily won’t need to expend the same amount of energy during a brisk walk as an older, sedentary person....The American Heart AssociationTrusted Source recommends at least 150 minutes of moderate-intensity aerobic exercise each week for optimal cardiovascular health. That’s equal to about 500 MET minutes per week, according to the Department of Health and Human Services*](https://www.healthline.com/health/what-are-mets#calculation)

According to [Fitbit's data dictionary](https://www.fitabase.com/media/1930/fitabasedatadictionary102320.pdf), the recorded MET in the datasets are by default multipled by 10, hence we will divide these numbers by 10 to obtain the actual MET values.

Below chart look at each user's daily combined MET values. We will be splitting the chart into 2 parts for easier viewing. 

```{r message=FALSE, warning=FALSE}
minmets %>% 
  mutate(date = date(ActivityMinute)) %>%
  mutate(time = format(ActivityMinute, format = "%H%M")) %>%
  transform(time = as.numeric(time)) %>% 
  mutate(time = time/100) %>%
  relocate(METs, .after = time) %>% 
  filter(row_number() <= 625860) %>% 
  ggplot() +
  geom_line(aes(time, METs/10)) +
  ylab('MET') +
  xlab('Time') +
  ggtitle('Part 1') +
  geom_hline(yintercept = 6, colour = 'blue') +
  scale_x_continuous(breaks = c(0, 3, 6, 9, 12, 15, 18, 21)) +
  scale_y_continuous(breaks = c(0, 6, 10, 15)) +
  facet_wrap(~Id)
```

```{r message=FALSE, warning=FALSE}
minmets %>% 
  mutate(date = date(ActivityMinute)) %>%
  mutate(time = format(ActivityMinute, format = "%H%M")) %>%
  transform(time = as.numeric(time)) %>% 
  mutate(time = time/100) %>%
  relocate(METs, .after = time) %>% 
  filter(row_number() >= 625861) %>% 
  ggplot() +
  geom_line(aes(time, METs/10)) +
  ylab('MET') +
  xlab('Time') +
  ggtitle('Part 2') +
  geom_hline(yintercept = 6, colour = 'blue') +
  scale_x_continuous(breaks = c(0, 3, 6, 9, 12, 15, 18, 21)) +
  scale_y_continuous(breaks = c(0, 6, 10, 15)) +
  facet_wrap(~Id)
```

According to this [article](https://www.healthline.com/health/what-are-mets#calculation), vigorous activities will have a MET value of approximately => 6 based upon an average person's weight of 70 kg. Higher MET values indicate higher energy expenditures.

The two charts above represent the energy expenditure of each user throughout the day, we can observe a routine based upon the pattern of the chart.  

For example, data from user ID 8253242879 (Part 2, col 3 row 3) spike between 9 am and 12 pm, with values reaching as high as >10 MET. It is reasonable to assume that this may be the user's workout timing each day. 

MET data from user ID 1503960366 (Part 1, col 1 row 1) is consistently >6 throughout the day, suggesting that this user may be engaged in labour intensive job. 

However if we were to look at an individual user energy expenditure on a day by day basis, we will be able to observe a new trend. We will focus on user ID 1503960366 for illustration.

```{r message=FALSE, warning=FALSE}
graph1 <- minmets %>% 
  mutate(date = date(ActivityMinute)) %>%
  mutate(time = format(ActivityMinute, format = "%H%M")) %>%
  transform(time = as.numeric(time)) %>% 
  mutate(time = time/100) %>% 
  relocate(METs, .after = time) %>% 
  filter(Id == 1503960366) %>%
  ggplot() +
  geom_line(aes(time, METs/10)) +
  ylab('METs') +
  xlab('Time') +
  ggtitle('MET over days') +
  scale_x_continuous(breaks = c(0, 3, 6, 9, 12, 15, 18, 21)) +
  scale_y_continuous(breaks = c(0, 1, 6, 10, 15)) +
  geom_hline(yintercept = 6, colour = 'blue') +
  transition_time(date) +
  labs(subtitle = "Date: {frame_time}")

animate(graph1, height = 500, width = 1000, fps = 30, duration = 20, end_pause = 60, res = 100)

```

In our initial analysis above, we have suggested that user ID 1503960366 may be engaged in a labour intensive job for long hours as the user's MET data were consistently >6 throughout the day. However, the day by day visualisation is suggesting otherwise. The energy expenditure observed is >6 at only certain period of the day with this trend varying on a day to day basis. This goes against the initial suggestion that user ID 1503960366 maybe engaged in labour intensive job.

The line chart that we have initially plotted which shows every user's data was based on static data. It stacks all the different days into a single chart, hence creating the illusion that user ID 1503960366 has a high energy expenditure throughout the days. Whereas now if we were to look at it on a day by day basis, it shows that user ID 1503960366 is only expending vigorous energy at certain periods of the day, at different times each day.  


**2. Users' Sleep behaviour**

**Sedentary vs Sleep hours**

According to Centers for Disease Control and Prevention [CDC](https://www.cdc.gov/sleep/about_sleep/how_much_sleep.html), adults are recommended to have 7 or more hours per night.

We will explore further whether sedentary behaviours affect a user's sleep duration.

```{r message=FALSE, warning=FALSE}
daily_activities_sleep %>% 
  ggplot(aes(SedentaryMinutes, TotalMinutesAsleep)) +
  geom_point() +
  geom_smooth() +
  geom_hline(yintercept = 420, colour = 'red') + #420mins = 7hrs sleep
  scale_y_continuous(breaks = c(0, 200, 400, 420, 600, 800)) +
  xlab('Total Sedentary Minutes') +
  ylab('Total Minutes Asleep') +
  stat_cor(method = "pearson")
```

We see a negative correlation (r = -0.6) between users' sedentary behaviour and their total minutes slept. This suggest that a higher sedentary behavior leads to a lower amount of sleep. 


**Average time to fall asleep**

In order to omit data of users who took naps, we have filtered out for totalsleeprecord = 1, so as to only focus on data of users who slept once per day. We have also removed 2 outliers from the analysis as they took an average of ~300mins & ~150mins to fall asleep.

```{r message=FALSE, warning=FALSE}
daily_activities_sleep %>% 
  transform(Id = as.character(Id)) %>% 
  mutate(timetosleep = TotalTimeInBed - TotalMinutesAsleep) %>% 
  filter(TotalSleepRecords == 1, Id != '1844505072', Id != '3977333714') %>% 
  select(timetosleep) %>% 
  summary(timetosleep)
```

```{r message=FALSE, warning=FALSE}
daily_activities_sleep %>% 
  transform(Id = as.character(Id)) %>% 
  mutate(timetosleep = TotalTimeInBed - TotalMinutesAsleep) %>% 
  filter(TotalSleepRecords == 1, Id != '1844505072', Id != '3977333714') %>% 
  ggplot(aes(Id, timetosleep)) +
  geom_boxplot() +
  geom_hline(yintercept = 26.6, colour = 'red') +
  scale_y_continuous(breaks = c(0, 26.6, 50, 100, 150)) +
  xlab('participant ID') +
  ylab('time to sleep') +
  theme(axis.text.x = element_text(angle = 90))
```

On average the users took around 26.6 minutes to fall sleep, which is 6 mins more than the average time for people to fall asleep. This suggest possible mild insomnia among the users according to this [article](https://www.sleep.org/sleep-questions/how-long-to-fall-asleep/). 


### Conclusion

During our analysis of the two datasets, we have noted that some users have recorded lesser days of data than the rest as shown below.

```{r message=FALSE, warning=FALSE}
idlist <- unique(minmets$Id)

xminmets <- minmets %>% 
  mutate(date = date(ActivityMinute))

for (i in 1:33) {
  dates <- xminmets %>% 
  filter(Id == idlist[i]) %>% 
  distinct(date)
  
  print(paste('No.',i, 'ID', idlist[i], ', days of data recorded:', count(dates)))
}
```

```{r message=FALSE, warning=FALSE}
idlist2 <- unique(daily_activities_sleep$Id)

for (i in 1:24) {
  dates <- daily_activities_sleep %>% 
  filter(Id == idlist2[i]) %>% 
  distinct(date)
  
  print(paste('No.',i, 'ID', idlist2[i], ', days of data recorded:', count(dates)))
}
```

With these new findings, and in addition to the risks we have highlighted above of sampling bias and that sampled units are generally not representative of larger target population of interest, we recommend for Bellabeat to either use their own data or to perform their own survey for a more accurate analysis.

Nevertheless, we can still draw some insights about the users from the analysis performed. We recommend for the following features to be added on Bellabeat's app:

1. To set daily reminders to user's device informing them to hit at least 30 minutes of moderate-intensity activities per day as per WHO's recommendation and an hourly prompt to user to [stand up and move around for 3 minutes](https://edition.cnn.com/2021/03/05/health/how-to-avoid-sedentary-behavior-wellness/index.html) to reduce their sedentary behaviour.

2. To set daily reminders to user's device 30 minutes before their own pre-set bedtime asking them to get ready for sleep. The reminder also provides a list of dos and don'ts to facilitate their sleep such as e.g. stop using electronic devices as the blue light emitted will affect the body's ability to prepare for sleep.
